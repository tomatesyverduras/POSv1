<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Productos - VENTA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        html { height: 100%; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            height: 100vh;
            overflow: hidden;
        }
        .dark body { background-color: #0f172a; }
        #app-container {
            display: grid; 
            height: 100%;
            grid-template-rows: auto auto 1fr auto; 
            overflow: hidden;
        }
        #main-header, #filters-container, #main-footer { flex-shrink: 0; }
        #main-content-wrapper { overflow-y: auto; min-height: 0; }
        .product-card {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        .dark .product-card {
            background-color: #1e293b;
            border-color: #334155;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px -5px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .dark .product-card:hover { box-shadow: 0 10px 20px -5px rgb(0 0 0 / 0.25); }
        
        .admin-only { display: none !important; }
        body.role-admin .admin-only { display: flex !important; }
        
        #loader, #gemini-loader {
            border: 4px solid #475569;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        .modal { transition: opacity 0.25s ease; }
        .modal-container { transition: transform 0.25s ease; }
        .view-section { display: none; animation: fadeIn 0.5s ease-in-out; height: 100%; }
        .view-section.active { display: flex; flex-direction: column; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .nav-item.active { color: #3b82f6; }
        .dark .nav-item.active { color: #60a5fa; }
        @keyframes cart-bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .cart-bounce { animation: cart-bounce 0.3s ease-in-out; }
        #notification-toast { transition: opacity 0.3s ease, transform 0.3s ease; }
        #payment-input { -moz-appearance: textfield; }
        #payment-input::-webkit-outer-spin-button, #payment-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #filters-container { transition: all 0.3s ease-in-out; max-height: 0; padding: 0; overflow: hidden; }
        #filters-container.open { max-height: 200px; padding-top: 1rem; padding-bottom: 1rem; }
        #promo-details { transition: all 0.3s ease-in-out; max-height: 0; overflow: hidden; opacity: 0; }
        #promo-details.open { max-height: 500px; opacity: 1; }
    </style>
</head>
<body class="dark:text-slate-300">

    <div id="auth-view" class="flex items-center justify-center h-screen bg-slate-100 dark:bg-slate-900">
        <div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-lg shadow-xl dark:bg-slate-800">
            <h2 class="text-2xl font-bold text-center text-gray-800 dark:text-slate-200">Iniciar Sesión</h2>
            <form id="login-form" class="space-y-6">
                <input type="email" id="email" placeholder="Correo" required class="w-full px-3 py-2 mt-1 border rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="admin@pos.com">
                <input type="password" id="password" placeholder="Contraseña" required class="w-full px-3 py-2 mt-1 border rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white" value="password">
                <div id="login-error" class="text-sm text-red-500 h-4"></div>
                <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">Ingresar</button>
            </form>
        </div>
    </div>

    <div id="app-container" class="hidden">
        <header id="main-header" class="z-40 bg-black/50 backdrop-blur-sm">
            <div class="container mx-auto px-4 sm:px-6 py-3">
                <div class="flex items-center justify-between">
                    <h1 id="header-title" class="text-xl font-bold text-white">Productos</h1>
                    <div class="flex items-center gap-1">
                        <button id="search-toggle-btn" title="Buscar" class="h-10 w-10 flex items-center justify-center text-white rounded-full hover:bg-white/20"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
                        <button id="add-product-button" title="Agregar Producto" class="admin-only items-center justify-center h-10 w-10 text-white rounded-full hover:bg-white/20"><svg class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" /></svg></button>
                        <button id="logout-button" title="Salir" class="h-10 w-10 flex items-center justify-center text-white rounded-full hover:bg-white/20"><svg class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" /></svg></button>
                        <button id="theme-toggle" title="Cambiar Tema" class="h-10 w-10 flex items-center justify-center text-white rounded-full hover:bg-white/20"></button>
                    </div>
                </div>
            </div>
        </header>
        <div id="filters-container" class="container mx-auto px-4 sm:px-6"></div>
        <div id="main-content-wrapper">
            <div id="productos-view" class="view-section">
                <main class="container mx-auto px-4 sm:px-6 pb-6 pt-0">
                    <div id="gallery-container" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6"></div>
                    <div id="no-results" class="hidden text-center py-16">
                        <h3 class="text-2xl font-bold text-slate-700 dark:text-slate-300">No se encontraron resultados</h3>
                        <p class="text-slate-500 dark:text-slate-400 mt-2">Intenta con otra búsqueda o cambia de categoría.</p>
                    </div>
                    <div id="loader-container" class="w-full text-center py-8"><div id="loader"></div></div>
                </main>
            </div>
            <div id="detail-view" class="view-section">
                <main class="container mx-auto px-4 sm:px-6 py-6">
                    <div class="mb-6"><button id="back-to-gallery-btn" class="flex items-center gap-2 text-slate-600 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-500 font-semibold"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>Volver</button></div>
                    <div id="product-detail-content" class="bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full flex flex-col md:flex-row"></div>
                     <div id="related-products-container" class="mt-8"></div>
                </main>
            </div>
            <div id="inventario-view" class="view-section container mx-auto p-4 sm:p-6">
                <div class="bg-white dark:bg-slate-800 rounded-lg shadow-md overflow-hidden">
                    <table class="min-w-full"><thead class="bg-slate-50 dark:bg-slate-700"><tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Producto</th><th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Stock</th></tr></thead><tbody id="inventory-table-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody></table>
                </div>
            </div>
            <div id="venta-view" class="view-section">
                <div class="p-4 h-full flex flex-col md:flex-row gap-4">
                    <div class="w-full md:w-1/2 lg:w-2/5 flex flex-col gap-4">
                        <div class="flex-grow bg-white dark:bg-slate-800 rounded-lg shadow-md p-4 flex flex-col min-h-0"><h3 class="text-lg font-bold mb-2 border-b pb-2 border-slate-200 dark:border-slate-700 flex-shrink-0">Carrito</h3><div id="cart-items-container" class="flex-grow space-y-3 overflow-y-auto"><p class="text-slate-500 text-center py-4">El carrito está vacío</p></div></div>
                        <div class="flex-shrink-0 bg-white dark:bg-slate-800 rounded-lg shadow-md p-4 space-y-2 text-lg"><div class="flex justify-between"><span>Subtotal:</span><span id="cart-subtotal">$0.00</span></div><div class="flex justify-between"><span>IVA (16%):</span><span id="cart-tax">$0.00</span></div><div class="flex justify-between font-bold text-xl border-t pt-2 mt-2 border-slate-200 dark:border-slate-700"><span>Total:</span><span id="cart-total">$0.00</span></div></div>
                    </div>
                    <div class="w-full md:w-1/2 lg:w-3/5 bg-white dark:bg-slate-800 rounded-lg shadow-md p-4 flex flex-col gap-4">
                        <div class="flex-grow space-y-4 flex flex-col justify-around"><div class="bg-slate-100 dark:bg-slate-900/70 rounded-lg p-4 text-right"><label for="payment-input" class="block text-sm text-slate-500 text-left mb-1">Paga con:</label><input type="number" id="payment-input" placeholder="0.00" class="w-full bg-transparent text-right text-4xl font-mono font-bold border-none focus:ring-0 p-0"></div><div class="bg-slate-100 dark:bg-slate-900/70 rounded-lg p-4 text-right"><p class="text-sm text-slate-500 text-left">Cambio:</p><p id="change-display" class="text-4xl font-mono font-bold text-green-500">$0.00</p></div></div>
                        <div class="grid grid-cols-2 gap-4 flex-shrink-0"><button id="cancel-sale-btn" class="w-full h-16 bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-400 font-bold rounded-lg hover:bg-red-200 dark:hover:bg-red-900 text-lg">Cancelar</button><button id="charge-btn" class="w-full h-16 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 text-lg">Cobrar</button></div>
                    </div>
                </div>
            </div>
            <div id="producto-form-view" class="view-section container mx-auto p-4 sm:p-6">
                 <div class="mb-6"><button id="back-from-form-btn" class="flex items-center gap-2 text-slate-600 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-500 font-semibold"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>Volver a Productos</button></div>
                <div class="bg-white dark:bg-slate-800 rounded-lg shadow-md p-6">
                    <h2 id="product-form-title" class="text-2xl font-bold mb-6 text-slate-800 dark:text-slate-200"></h2>
                    <form id="product-form" class="space-y-4">
                        <input type="text" id="producto" placeholder="Nombre del Producto" required class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        <input type="text" id="codigo" placeholder="Código" required class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        <input type="text" id="categoria" placeholder="Categoría" required class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        <div class="grid grid-cols-2 gap-4"><input type="number" id="precio_compra" placeholder="Precio Compra" step="0.01" required class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white"><input type="number" id="precio_venta" placeholder="Precio Venta" step="0.01" required class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white"></div>
                        <input type="number" id="stock" placeholder="Stock" step="1" required class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        <input type="text" id="tags" placeholder="Etiquetas (separadas por coma)" class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        <div class="relative">
                            <textarea id="descripcion" placeholder="Descripción del producto" rows="3" class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white"></textarea>
                            <button type="button" id="generate-description-btn" class="absolute bottom-2 right-2 px-3 py-1.5 text-xs font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">✨ Sugerir Descripción</button>
                        </div>
                        <div id="gemini-loader-container" class="hidden justify-center items-center"><div id="gemini-loader" class="!w-6 !h-6"></div></div>
                        <input type="url" id="imagen_url" placeholder="URL de la Imagen" required class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        <div class="border-t border-slate-200 dark:border-slate-700 pt-4">
                            <label class="flex items-center gap-3 cursor-pointer"><input type="checkbox" id="promo-toggle" name="isPromo" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500"><span class="font-semibold">Crear Paquete Promocional</span></label>
                            <div id="promo-details" class="space-y-3 mt-3">
                                <div id="selected-promo-product" class="hidden items-center gap-3 p-2 bg-blue-50 dark:bg-blue-900/50 rounded-md"></div>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 pt-4"><button type="button" id="cancel-product-form" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-slate-600 dark:text-slate-200">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Guardar</button></div>
                    </form>
                </div>
            </div>
            <div id="perfil-view" class="view-section container mx-auto p-4 sm:p-6"></div>
            <div id="desempeno-vendedor-view" class="view-section container mx-auto p-4 sm:p-6"></div>
            <div id="payroll-view" class="view-section container mx-auto p-4 sm:p-6"></div>
            <div id="financial-reports-view" class="view-section container mx-auto p-4 sm:p-6"></div>
        </div>
        <footer id="main-footer" class="z-40 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700">
            <nav id="bottom-nav" class="container mx-auto px-4 h-16 flex justify-around items-center">
                <button data-view="venta" class="nav-item flex flex-col items-center justify-center text-slate-500 dark:text-slate-400 w-full h-full"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg><span class="text-xs mt-1">Venta</span></button>
                <button data-view="productos" class="nav-item flex flex-col items-center justify-center text-slate-500 dark:text-slate-400 w-full h-full"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg><span class="text-xs mt-1">Productos</span></button>
                <button data-view="inventario" class="nav-item flex flex-col items-center justify-center text-slate-500 dark:text-slate-400 w-full h-full"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg><span class="text-xs mt-1">Inventario</span></button>
                <button data-view="perfil" class="nav-item flex flex-col items-center justify-center text-slate-500 dark:text-slate-400 w-full h-full"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg><span class="text-xs mt-1">Perfil</span></button>
            </nav>
        </footer>
    </div>
    
    <!-- Modales -->
    <div id="notification-toast" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-md opacity-0 translate-y-2 pointer-events-none"></div>
    <div id="confirm-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4 opacity-0"><div class="modal-container bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-sm p-6 scale-95"><h3 id="confirm-title" class="text-lg font-bold text-slate-800 dark:text-slate-200">Confirmar Acción</h3><p id="confirm-message" class="text-sm text-slate-500 dark:text-slate-400 mt-2 mb-6">¿Estás seguro? Esta acción no se puede deshacer.</p><div class="flex justify-end gap-3"><button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-slate-600 dark:text-slate-200">Cancelar</button><button id="confirm-action-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirmar</button></div></div></div>
    <div id="ticket-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4 opacity-0">
        <div class="modal-container bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-sm p-6 scale-95 flex flex-col gap-4">
            <h3 class="text-xl font-bold text-center text-slate-800 dark:text-slate-200">Ticket de Venta</h3>
            <div id="ticket-image-container" class="bg-white p-2 rounded-md overflow-y-auto"><canvas id="ticket-canvas"></canvas></div>
            <div class="flex justify-center gap-4"><button id="download-ticket-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Descargar</button><button id="close-ticket-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-slate-600 dark:text-slate-200">Cerrar</button></div>
        </div>
    </div>
    <div id="promo-search-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4 opacity-0">
        <div class="modal-container bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-md p-6 scale-95 flex flex-col gap-4">
            <h3 class="text-xl font-bold text-slate-800 dark:text-slate-200">Seleccionar Producto del Paquete</h3>
            <input type="search" id="modal-promo-search-input" placeholder="Buscar por nombre, código o etiqueta..." class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
            <div id="modal-promo-search-results" class="max-h-64 overflow-y-auto space-y-2"><p class="text-slate-500 text-center">Escribe para buscar un producto.</p></div>
            <div class="flex justify-end"><button type="button" id="close-promo-search-modal-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-slate-600 dark:text-slate-200">Cancelar</button></div>
        </div>
    </div>
    <!-- Admin Modals -->
    <div id="expense-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4 opacity-0">
        <div class="modal-container bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-sm p-6 scale-95">
            <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200 mb-4">Registrar Gasto General</h3>
            <form id="expense-form" class="space-y-4">
                <input type="text" id="expense-description" placeholder="Descripción del Gasto" required class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                <input type="number" id="expense-amount" placeholder="Monto" step="0.01" required class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                <select id="expense-category" required class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                    <option value="" disabled selected>Selecciona una categoría</option>
                    <option value="Suministros">Suministros</option>
                    <option value="Servicios">Servicios</option>
                    <option value="Mantenimiento">Mantenimiento</option>
                    <option value="Otros">Otros</option>
                </select>
                <div class="flex justify-end gap-3 pt-2"><button type="button" id="cancel-expense-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-slate-600 dark:text-slate-200">Cancelar</button><button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Guardar Gasto</button></div>
            </form>
        </div>
    </div>
    <div id="income-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4 opacity-0">
        <div class="modal-container bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-sm p-6 scale-95">
            <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200 mb-4">Registrar Ingreso General</h3>
            <form id="income-form" class="space-y-4">
                <input type="text" id="income-description" placeholder="Descripción del Ingreso" required class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                <input type="number" id="income-amount" placeholder="Monto" step="0.01" required class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                <select id="income-category" required class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                    <option value="" disabled selected>Selecciona una categoría</option>
                    <option value="Ventas Extras">Ventas Extras</option>
                    <option value="Inversiones">Inversiones</option>
                    <option value="Otros">Otros</option>
                </select>
                <div class="flex justify-end gap-3 pt-2"><button type="button" id="cancel-income-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-slate-600 dark:text-slate-200">Cancelar</button><button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Guardar Ingreso</button></div>
            </form>
        </div>
    </div>
    <div id="transaction-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4 opacity-0">
        <div class="modal-container bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-sm p-6 scale-95">
            <h3 id="transaction-modal-title" class="text-lg font-bold text-slate-800 dark:text-slate-200 mb-4"></h3>
            <form id="transaction-form" class="space-y-4">
                <input type="hidden" id="transaction-employee-id">
                <input type="hidden" id="transaction-type">
                <input type="text" id="transaction-description" placeholder="Descripción" required class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                <input type="number" id="transaction-amount" placeholder="Monto" step="0.01" required class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                <div class="flex justify-end gap-3 pt-2"><button type="button" class="cancel-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-slate-600 dark:text-slate-200">Cancelar</button><button type="submit" class="submit-btn px-4 py-2 text-white rounded-md">Guardar</button></div>
            </form>
        </div>
    </div>
    <div id="employee-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4 opacity-0">
        <div class="modal-container bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-sm p-6 scale-95">
            <h3 id="employee-modal-title" class="text-lg font-bold text-slate-800 dark:text-slate-200 mb-4">Agregar Empleado</h3>
            <form id="employee-form" class="space-y-4">
                <input type="hidden" id="employee-id">
                <input type="email" id="employee-email" placeholder="Correo del Empleado" required class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                <input type="password" id="employee-password" placeholder="Contraseña (dejar en blanco para no cambiar)" class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                <input type="number" id="employee-base-salary" placeholder="Salario Base Mensual" step="0.01" required class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                <div class="flex justify-end gap-3 pt-2"><button type="button" id="cancel-employee-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-slate-600 dark:text-slate-200">Cancelar</button><button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Guardar Empleado</button></div>
            </form>
        </div>
    </div>
    <div id="payment-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4 opacity-0">
        <div class="modal-container bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-sm p-6 scale-95">
            <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200 mb-4">Registrar Pago</h3>
            <form id="payment-form" class="space-y-4">
                <input type="hidden" id="payment-employee-id">
                <input type="text" id="payment-description" placeholder="Descripción (ej. Nómina Enero)" required class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                <input type="number" id="payment-amount" placeholder="Monto" step="0.01" required class="w-full p-3 border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" id="cancel-payment-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-slate-600 dark:text-slate-200">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Registrar Pago</button>
                </div>
            </form>
        </div>
    </div>
    <div id="payment-history-modal" class="modal fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4 opacity-0">
        <div class="modal-container bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-2xl p-6 scale-95 flex flex-col">
            <h3 id="payment-history-title" class="text-xl font-bold text-slate-800 dark:text-slate-200 mb-4">Historial de Pagos</h3>
            <div id="payment-history-content" class="max-h-96 overflow-y-auto"></div>
            <div class="flex justify-end mt-6"><button type="button" id="close-payment-history-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 dark:bg-slate-600 dark:text-slate-200">Cerrar</button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, setPersistence, browserLocalPersistence, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, push, update, remove, onValue, get, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        document.addEventListener('DOMContentLoaded', () => {
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyCU9meIionjsLxtKH-q_k64dHsmRgHPKrk",
                authDomain: "posventa-9168b.firebaseapp.com",
                databaseURL: "https://posventa-9168b-default-rtdb.firebaseio.com",
                projectId: "posventa-9168b",
                storageBucket: "posventa-9168b.appspot.com",
                messagingSenderId: "602077008054",
                appId: "1:602077008054:web:ca857c7566a9ce0945d617",
                measurementId: "G-W5L6995VDE"
            };
            
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getDatabase(app);

            // State variables
            let allProducts = [], allSales = [], allUsers = {}, allTransactions = { bonuses: [], deductions: [] }, allPayrollPayments = [];
            let allGeneralIncome = [], allGeneralExpenses = [];
            let currentCategory = 'All', cartItems = [], selectedPromoProduct = null, currentEditingKey = null, currentUserRole = null;
            let confirmActionCallback = null;
            let salesChart = null;
            let payrollChart = null;
            let incomeExpenseChart = null;
            let categorySalesChart = null;


            // DOM Elements
            const authView = document.getElementById('auth-view');
            const appContainer = document.getElementById('app-container');
            const mainContentWrapper = document.getElementById('main-content-wrapper');
            const galleryContainer = document.getElementById('gallery-container');
            const inventoryTableBody = document.getElementById('inventory-table-body');
            const loader = document.getElementById('loader-container');
            const noResultsDiv = document.getElementById('no-results');
            const backToGalleryBtn = document.getElementById('back-to-gallery-btn');
            const bottomNav = document.getElementById('bottom-nav');
            const headerTitle = document.getElementById('header-title');
            const logoutButton = document.getElementById('logout-button');
            const addProductButton = document.getElementById('add-product-button');
            const themeToggle = document.getElementById('theme-toggle');
            const cartItemsContainer = document.getElementById('cart-items-container');
            const paymentInput = document.getElementById('payment-input');
            const searchToggleButton = document.getElementById('search-toggle-btn');
            const filtersContainer = document.getElementById('filters-container');
            const productForm = document.getElementById('product-form');
            const productFormTitle = document.getElementById('product-form-title');
            const perfilView = document.getElementById('perfil-view');
            const desempenoVendedorView = document.getElementById('desempeno-vendedor-view');
            const payrollView = document.getElementById('payroll-view');
            const financialReportsView = document.getElementById('financial-reports-view');

            const showView = (viewId, param = null) => {
                document.querySelectorAll('.view-section').forEach(view => view.classList.remove('active'));
                const newView = document.getElementById(viewId);
                if (newView) newView.classList.add('active');
                const viewName = viewId.replace('-view', '');
                
                if (viewId === 'perfil-view') {
                    renderProfileView(auth.currentUser);
                } else if (viewId === 'desempeno-vendedor-view' && param) {
                    renderSellerPerformanceView(param.uid);
                }

                if (!['detail', 'producto-form', 'desempeno-vendedor', 'payroll', 'financial-reports'].includes(viewName)) {
                    headerTitle.textContent = viewName.charAt(0).toUpperCase() + viewName.slice(1);
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.toggle('active', item.dataset.view === viewName);
                    });
                } else if (viewId === 'producto-form-view') {
                    headerTitle.textContent = productFormTitle.textContent;
                } else if (viewId === 'desempeno-vendedor-view') {
                     headerTitle.textContent = "Desempeño";
                } else if (viewId === 'payroll-view') {
                     headerTitle.textContent = "Nómina";
                } else if (viewId === 'financial-reports-view') {
                     headerTitle.textContent = "Reportes Financieros";
                }
                renderFiltersForView(viewName);
                mainContentWrapper.scrollTop = 0;
            }

            const showProductDetail = (productData) => {
                const container = document.getElementById('product-detail-content');
                const formattedPrice = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(productData.precio_venta);
                let detailHTML = `<div class="w-full md:w-1/2 h-80 md:h-auto bg-cover bg-center rounded-t-lg md:rounded-l-lg md:rounded-t-none" style="background-image: url('${productData.imagen_url}')"></div><div class="w-full md:w-1/2 p-8 flex flex-col"><div class="flex-grow overflow-y-auto"><h2 class="text-3xl font-bold text-slate-800 dark:text-white mb-2">${productData.producto}</h2><p class="text-slate-500 dark:text-slate-400 mb-6">${productData.categoria || 'Sin Categoría'}</p><h4 class="font-semibold text-slate-800 dark:text-white mb-2">Descripción</h4><p class="text-slate-600 dark:text-slate-300 mb-6 whitespace-pre-wrap">${productData.descripcion || 'No hay descripción disponible.'}</p>`;
                if (productData.isPromo && productData.promoProductKey) {
                    const promoProduct = allProducts.find(p => p.key === productData.promoProductKey);
                    if(promoProduct) {
                        detailHTML += `<div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700"><h4 class="font-semibold text-slate-800 dark:text-white mb-2">Incluye en Paquete:</h4><div class="flex items-center gap-3"><img src="${promoProduct.imagen_url}" class="w-12 h-12 object-cover rounded-md" /><div><p class="font-semibold">${promoProduct.producto}</p><p class="text-sm text-slate-500">${promoProduct.codigo}</p></div></div></div>`;
                    }
                }
                detailHTML += `
                        <button id="show-related-btn" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">✨ Ver Productos Relacionados</button>
                        </div><div class="flex justify-between items-center mt-6 pt-6 border-t border-slate-200 dark:border-slate-700"><p class="text-4xl font-extrabold text-blue-600 dark:text-blue-500">${formattedPrice}</p><span class="text-sm font-medium text-slate-600 dark:text-slate-400">Stock: ${productData.stock || 0}</span></div></div>`;
                container.innerHTML = detailHTML;
                showView('detail-view');
            }

            const setupProductForm = (mode, productData = {}, productKey = null) => {
                productForm.reset();
                currentEditingKey = productKey;
                selectedPromoProduct = null;
                const promoDetails = document.getElementById('promo-details');
                const selectedPromoContainer = document.getElementById('selected-promo-product');
                const promoToggleCheckbox = document.getElementById('promo-toggle');
                promoDetails.classList.remove('open');
                selectedPromoContainer.classList.add('hidden');
                promoToggleCheckbox.checked = false;

                if (mode === 'edit') {
                    productFormTitle.textContent = 'Editar Producto';
                    Object.keys(productData).forEach(key => {
                        const el = productForm.elements[key];
                        if (el) {
                           if (el.name === 'isPromo' && el.type === 'checkbox') {
                                el.checked = productData.isPromo || false;
                            } else if(el.id === key) {
                                el.value = productData[key];
                            }
                        }
                    });
                    if (productData.isPromo) {
                        promoToggleCheckbox.checked = true;
                        promoDetails.classList.add('open');
                        if (productData.promoProductKey) {
                            const promoProd = allProducts.find(p => p.key === productData.promoProductKey);
                            if (promoProd) selectPromoProduct(promoProd);
                        }
                    }
                } else {
                    productFormTitle.textContent = 'Agregar Nuevo Producto';
                }
                showView('producto-form-view');
            };
            
            const fetchAllData = () => {
                loader.style.display = 'block';
                const refs = {
                    productos: ref(db, 'productos'),
                    sales: ref(db, 'sales'),
                    users: ref(db, 'users'),
                    bonuses: ref(db, 'transactions/bonuses'),
                    deductions: ref(db, 'transactions/deductions'),
                    payrollPayments: ref(db, 'payrollPayments'),
                    generalIncome: ref(db, 'ingresos'),
                    generalExpenses: ref(db, 'gastos'),
                };

                const createArrayFromSnapshot = (snap) => {
                    const data = [];
                    if (snap.exists()) {
                        snap.forEach(child => {
                            data.push({ key: child.key, ...child.val() });
                        });
                    }
                    return data;
                };

                onValue(refs.productos, (snap) => {
                    allProducts = createArrayFromSnapshot(snap);
                    applyGalleryFilters();
                    renderInventoryList(allProducts);
                    renderCategoryDropdown(); 
                });

                onValue(refs.sales, (snap) => { allSales = createArrayFromSnapshot(snap); });
                onValue(refs.users, (snap) => { allUsers = snap.exists() ? snap.val() : {}; });
                onValue(refs.bonuses, (snap) => { allTransactions.bonuses = createArrayFromSnapshot(snap); });
                onValue(refs.deductions, (snap) => { allTransactions.deductions = createArrayFromSnapshot(snap); });
                onValue(refs.payrollPayments, (snap) => { allPayrollPayments = createArrayFromSnapshot(snap); });
                onValue(refs.generalIncome, (snap) => { allGeneralIncome = createArrayFromSnapshot(snap); });
                onValue(refs.generalExpenses, (snap) => { allGeneralExpenses = createArrayFromSnapshot(snap); });

                loader.style.display = 'none';
            }

            const createProductCard = (key, data) => { const card = document.createElement('div'); card.className = 'product-card rounded-lg overflow-hidden shadow-lg dark:border dark:border-slate-700'; card.dataset.key = key; const formattedPrice = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(data.precio_venta); const stock = data.stock || 0; let stockLabel; if (data.isPromo) { stockLabel = `<span class="bg-purple-100 text-purple-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-purple-900 dark:text-purple-300">OFERTA</span>`; } else if (stock === 0) { stockLabel = `<span class="text-xs font-bold text-red-500">Agotado</span>`; } else { const stockColor = stock < 6 ? 'text-yellow-500' : 'text-green-600'; stockLabel = `<span class="text-xs font-bold ${stockColor}">${stock} en Stock</span>`; } card.innerHTML = `<div class="relative aspect-[3/4]"><img src="${data.imagen_url}" alt="${data.producto}" class="absolute h-full w-full object-cover" onerror="this.src='https://placehold.co/600x800/e2e8f0/4a5568?text=N/A'"><div class="absolute top-2 right-2 space-x-2 admin-only"><button data-key="${key}" class="edit-btn p-2 bg-blue-600/80 text-white rounded-full hover:bg-blue-600 backdrop-blur-sm"><svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button><button data-key="${key}" class="delete-btn p-2 bg-red-600/80 text-white rounded-full hover:bg-red-600 backdrop-blur-sm"><svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></div><button data-key="${key}" class="add-to-cart-gallery-btn absolute bottom-2 right-2 p-2 bg-green-500/80 text-white rounded-full hover:bg-green-500 backdrop-blur-sm"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" /></svg></button></div><div class="p-4"><div class="flex justify-between items-center mb-2"><p class="text-xs text-slate-500 dark:text-slate-400">${data.categoria || 'Sin Categoría'}</p>${stockLabel}</div><h3 class="font-semibold text-slate-800 dark:text-slate-200 truncate">${data.producto}</h3><p class="text-lg font-bold text-blue-600 dark:text-blue-500 mt-1">${formattedPrice}</p></div>`; return card; }
            const renderFiltersForView = (viewName) => { if (!filtersContainer) return; filtersContainer.innerHTML = ''; searchToggleButton.classList.toggle('hidden', viewName !== 'productos'); filtersContainer.classList.remove('open'); if (viewName === 'productos') { let filtersHTML = `<div class="flex flex-col md:flex-row gap-4 items-center"><div class="flex-grow w-full"><input type="search" id="search-box-gallery" placeholder="Buscar por nombre, código, categoría o etiqueta..." class="w-full px-5 py-3 rounded-full border-2 border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500 focus:ring-2 focus:ring-blue-500 focus:outline-none focus:border-blue-500 dark:focus:border-blue-500 shadow-sm"></div><div class="relative w-full md:w-auto md:min-w-[200px]"><select id="category-dropdown" class="w-full px-4 py-3 text-sm rounded-full border-2 border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 focus:ring-2 focus:ring-blue-500 focus:outline-none focus:border-blue-500 dark:focus:border-blue-500 shadow-sm"></select><div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500"><svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg></div></div></div>`; filtersContainer.innerHTML = filtersHTML; document.getElementById('search-box-gallery').addEventListener('input', applyGalleryFilters); renderCategoryDropdown(); document.getElementById('category-dropdown').addEventListener('change', (e) => { currentCategory = e.target.value; applyGalleryFilters(); }); } }
            const displayProducts = (productsToDisplay) => { galleryContainer.innerHTML = ''; noResultsDiv.classList.toggle('hidden', productsToDisplay.length > 0); productsToDisplay.forEach(p => { galleryContainer.appendChild(createProductCard(p.key, p)); }); }
            const renderInventoryList = (products) => { inventoryTableBody.innerHTML = ''; if (products.length === 0) { inventoryTableBody.innerHTML = '<tr><td colspan="2" class="text-center p-8 text-slate-500">No se encontraron productos.</td></tr>'; return; } products.sort((a,b) => (a.stock || 0) - (b.stock || 0)).forEach(p => { const stock = p.stock || 0; let stockColor = stock < 6 ? 'text-yellow-500' : 'text-green-600'; if (stock === 0) stockColor = 'text-red-500'; const row = document.createElement('tr'); row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap"><div class="flex items-center"><div class="flex-shrink-0 h-10 w-10"><img class="h-10 w-10 rounded-full object-cover" src="${p.imagen_url}" alt=""></div><div class="ml-4"><div class="text-sm font-medium text-slate-900 dark:text-white">${p.producto}</div><div class="text-sm text-slate-500 dark:text-slate-400">${p.codigo}</div></div></div></td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium ${stockColor}">${stock} unidades</td>`; inventoryTableBody.appendChild(row); }); }
            const applyGalleryFilters = () => { const gallerySearchBox = document.getElementById('search-box-gallery'); const searchTerm = gallerySearchBox ? gallerySearchBox.value.toLowerCase().trim() : ''; const categoryDropdown = document.getElementById('category-dropdown'); currentCategory = categoryDropdown ? categoryDropdown.value : 'All'; let filtered = allProducts; if (currentCategory !== 'All') { filtered = filtered.filter(p => (p.categoria || 'Sin Categoría') === currentCategory); } if (searchTerm) { filtered = filtered.filter(p => { const tags = (p.tags || '').toLowerCase(); return p.producto.toLowerCase().includes(searchTerm) || p.codigo.toLowerCase().includes(searchTerm) || (p.categoria || '').toLowerCase().includes(searchTerm) || tags.includes(searchTerm); }); } displayProducts(filtered); }
            const renderCategoryDropdown = () => { const categoryDropdown = document.getElementById('category-dropdown'); if (!categoryDropdown) return; const categories = ['All', ...new Set(allProducts.map(p => p.categoria || 'Sin Categoría').sort())]; categoryDropdown.innerHTML = categories.map(cat => `<option value="${cat}">${cat === 'All' ? 'Todas las Categorías' : cat}</option>`).join(''); categoryDropdown.value = currentCategory; }
            const updateCart = () => { const cartSubtotalEl = document.getElementById('cart-subtotal'); const cartTaxEl = document.getElementById('cart-tax'); const cartTotalEl = document.getElementById('cart-total'); if (cartItems.length === 0) { cartItemsContainer.innerHTML = '<p class="text-slate-500 text-center py-4">El carrito está vacío</p>'; } else { cartItemsContainer.innerHTML = cartItems.map((item, index) => `<div class="flex items-center gap-3 p-1 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700/50"><img src="${item.imagen_url}" class="w-10 h-10 object-cover rounded-md flex-shrink-0" /><div class="flex-grow min-w-0"><p class="font-semibold text-sm truncate">${item.producto}</p><p class="text-xs text-slate-500">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(item.precio_venta)}</p></div><input type="number" value="${item.quantity}" min="1" max="${item.stock}" class="w-16 text-center bg-slate-100 dark:bg-slate-700 rounded-md p-1 quantity-input" data-index="${index}"><button class="text-red-500 hover:text-red-700 remove-item-btn p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50" data-index="${index}"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></div>`).join(''); } const subtotal = cartItems.reduce((acc, item) => acc + (item.precio_venta * item.quantity), 0); const tax = subtotal * 0.16; const total = subtotal + tax; cartSubtotalEl.textContent = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(subtotal); cartTaxEl.textContent = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(tax); cartTotalEl.textContent = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(total); updateChange(); }
            const addToCart = (product) => { if (product.stock <= 0) { showToast('Este producto está agotado.', true); return; } const existingItem = cartItems.find(item => item.key === product.key); if (existingItem) { if (existingItem.quantity < product.stock) existingItem.quantity++; else showToast('No hay más stock disponible.', true); } else { cartItems.push({ ...product, quantity: 1 }); } updateCart(); const ventaNavIcon = document.querySelector('.nav-item[data-view="venta"]'); ventaNavIcon.classList.add('cart-bounce'); setTimeout(() => ventaNavIcon.classList.remove('cart-bounce'), 300); }
            const updateChange = () => { const total = cartItems.reduce((acc, item) => acc + (item.precio_venta * item.quantity), 0) * 1.16; const paid = parseFloat(paymentInput.value) || 0; const change = paid - total; document.getElementById('change-display').textContent = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(change > 0 ? change : 0); }
            function openModal(modalId) { const modal = document.getElementById(modalId); modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('.modal-container').classList.remove('scale-95'); }, 10); }
            function closeModal(modalId) { const modal = document.getElementById(modalId); modal.classList.add('opacity-0'); modal.querySelector('.modal-container').classList.add('scale-95'); setTimeout(() => modal.classList.add('hidden'), 250); }
            function showToast(message, isError = false) { const toast = document.getElementById('notification-toast'); if (!toast) return; toast.textContent = message; toast.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-md transition-all duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`; toast.classList.remove('opacity-0', 'translate-y-2'); setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-2'); }, 3000); }
            const sunIcon = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`;
            const moonIcon = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`;
            const setupTheme = () => { if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) { document.documentElement.classList.add('dark'); themeToggle.innerHTML = sunIcon; } else { document.documentElement.classList.remove('dark'); themeToggle.innerHTML = moonIcon; } };
            
            setPersistence(auth, browserLocalPersistence).catch((error) => {
                console.error("Error al configurar persistencia:", error);
            });

            const initializeUserSession = async (user) => {
                const userRoleRef = ref(db, 'users/' + user.uid);
                try {
                    const snapshot = await get(userRoleRef);
                    const userData = snapshot.val();
                    currentUserRole = userData ? userData.role : null;

                    if (currentUserRole) {
                        document.body.classList.remove('role-admin', 'role-employee');
                        document.body.classList.add(`role-${currentUserRole}`);
                        authView.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        fetchAllData();
                        showView('productos-view'); 
                    } else {
                        console.warn("Usuario sin rol definido:", user.uid);
                        showToast('Usuario no autorizado. Contacta al administrador.', true);
                        signOut(auth);
                    }
                } catch (error) {
                    console.error("Error getting user data:", error);
                    showToast('Error al verificar el rol del usuario.', true);
                    signOut(auth);
                }
            };
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    initializeUserSession(user);
                } else {
                    document.body.classList.remove('role-admin', 'role-employee');
                    authView.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                }
            });

            document.getElementById('login-form').addEventListener('submit', async (e) => { e.preventDefault(); const loginError = document.getElementById('login-error'); loginError.textContent = ''; try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } catch (error) { loginError.textContent = 'Credenciales incorrectas.'; } });
            logoutButton.addEventListener('click', () => signOut(auth));
            
            addProductButton.addEventListener('click', () => setupProductForm('add'));
            productForm.addEventListener('submit', (e) => { e.preventDefault(); const key = currentEditingKey; const isPromo = document.getElementById('promo-toggle').checked; const data = { producto: document.getElementById('producto').value, codigo: document.getElementById('codigo').value, categoria: document.getElementById('categoria').value,  precio_compra: parseFloat(document.getElementById('precio_compra').value), precio_venta: parseFloat(document.getElementById('precio_venta').value), stock: parseInt(document.getElementById('stock').value), imagen_url: document.getElementById('imagen_url').value, tags: document.getElementById('tags').value, descripcion: document.getElementById('descripcion').value, isPromo: isPromo, promoProductKey: isPromo && selectedPromoProduct ? selectedPromoProduct.key : null, }; if (isPromo && !selectedPromoProduct) { showToast('Debes seleccionar un producto para el paquete promocional.', true); return; } const action = key ? update(ref(db, `productos/${key}`), data) : set(push(ref(db, 'productos')), data); action.then(() => { showView('productos-view'); }).catch(err => showToast('Error al guardar producto.', true)); });
            galleryContainer.addEventListener('click', (e) => { const card = e.target.closest('.product-card'); if (!card) return; const key = card.dataset.key; const productData = allProducts.find(p => p.key === key); if (!productData) return; const editBtn = e.target.closest('.edit-btn'); const deleteBtn = e.target.closest('.delete-btn'); const addToCartBtn = e.target.closest('.add-to-cart-gallery-btn'); if (editBtn) { setupProductForm('edit', productData, key); } else if (deleteBtn) { showConfirmation('Borrar Producto', '¿Estás seguro de que quieres borrar este producto? Esta acción no se puede deshacer.', () => { remove(ref(db, `productos/${key}`)); }); } else if (addToCartBtn) { addToCart(productData); } else { showProductDetail(productData); } });
            
            const showConfirmation = (title, message, callback) => {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                confirmActionCallback = callback;
                openModal('confirm-modal');
            };

            document.getElementById('confirm-cancel-btn').addEventListener('click', () => closeModal('confirm-modal'));
            document.getElementById('confirm-action-btn').addEventListener('click', () => {
                if (typeof confirmActionCallback === 'function') {
                    confirmActionCallback();
                }
                closeModal('confirm-modal');
                confirmActionCallback = null;
            });

            backToGalleryBtn.addEventListener('click', () => showView('productos-view'));
            document.getElementById('back-from-form-btn').addEventListener('click', () => showView('productos-view'));
            document.getElementById('cancel-product-form').addEventListener('click', () => showView('productos-view'));
            bottomNav.addEventListener('click', (e) => { const navButton = e.target.closest('.nav-item'); if (navButton) showView(`${navButton.dataset.view}-view`); });
            searchToggleButton.addEventListener('click', () => { filtersContainer.classList.toggle('open'); });
            cartItemsContainer.addEventListener('change', (e) => { if (e.target.classList.contains('quantity-input')) { const index = parseInt(e.target.dataset.index); const newQuantity = parseInt(e.target.value); const item = cartItems[index]; const product = allProducts.find(p => p.key === item.key); if (newQuantity > product.stock) { showToast(`Solo quedan ${product.stock} unidades de ${product.producto}.`, true); e.target.value = item.quantity; return; } if (newQuantity > 0) { item.quantity = newQuantity; } else { cartItems.splice(index, 1); } updateCart(); } });
            cartItemsContainer.addEventListener('click', (e) => { const removeBtn = e.target.closest('.remove-item-btn'); if (removeBtn) { const index = removeBtn.dataset.index; cartItems.splice(index, 1); updateCart(); } });
            paymentInput.addEventListener('input', updateChange);
            document.getElementById('cancel-sale-btn').addEventListener('click', () => { cartItems = []; paymentInput.value = ''; updateCart(); });
            document.getElementById('charge-btn').addEventListener('click', () => { if(cartItems.length === 0) { showToast('El carrito está vacío.', true); return; } for (const item of cartItems) { const productData = allProducts.find(p => p.key === item.key); if (!productData || productData.stock < item.quantity) { showToast(`No hay suficiente stock para ${item.producto}.`, true); return; } if(item.isPromo && item.promoProductKey) { const promoProd = allProducts.find(p => p.key === item.promoProductKey); if(!promoProd || promoProd.stock < item.quantity) { showToast(`No hay suficiente stock para el producto promocional ${promoProd.producto}.`, true); return; } } } generateTicketCanvas(); openModal('ticket-modal'); });
            
            const finalizeSale = () => {
                const updates = {};
                const saleId = push(ref(db, 'sales')).key;
                const saleItems = cartItems.map(item => ({ producto: item.producto, quantity: item.quantity, precio_compra: item.precio_compra, precio_venta: item.precio_venta }));
                const totalSale = cartItems.reduce((acc, item) => acc + (item.precio_venta * item.quantity), 0) * 1.16;
                updates[`/sales/${saleId}`] = { sellerId: auth.currentUser.uid, timestamp: Date.now(), total: totalSale, items: saleItems };
                cartItems.forEach(item => {
                    const productData = allProducts.find(p => p.key === item.key);
                    const newStock = productData.stock - item.quantity;
                    updates[`/productos/${item.key}/stock`] = newStock;
                    if (newStock < 10 && !productData.isPromo) {
                        showToast(`¡Alerta! Stock bajo para ${productData.producto} (${newStock} unidades).`, true);
                    }
                    if (item.isPromo && item.promoProductKey) {
                        const promoProd = allProducts.find(p => p.key === item.promoProductKey);
                        if (promoProd) {
                            const newPromoStock = promoProd.stock - item.quantity;
                            updates[`/productos/${item.promoProductKey}/stock`] = newPromoStock;
                            if (newPromoStock < 10 && !promoProd.isPromo) {
                                showToast(`¡Alerta! Stock bajo para ${promoProd.producto} (${newPromoStock} unidades).`, true);
                            }
                        }
                    }
                });
                update(ref(db), updates).then(() => {
                    showToast('¡Venta completada!');
                    cartItems = [];
                    paymentInput.value = '';
                    updateCart();
                }).catch(error => showToast('Error al procesar la venta.', true));
            }

            document.getElementById('close-ticket-btn').addEventListener('click', () => { closeModal('ticket-modal'); finalizeSale(); });
            document.getElementById('download-ticket-btn').addEventListener('click', () => { const canvas = document.getElementById('ticket-canvas'); const link = document.createElement('a'); link.download = `ticket-venta-${Date.now()}.png`; link.href = canvas.toDataURL('image/png'); link.click(); });
            function generateTicketCanvas() { const canvas = document.getElementById('ticket-canvas'); const ctx = canvas.getContext('2d'); const lineHeight = 22; const startY = 25; let currentY = startY; const canvasWidth = 320; const padding = 15; const baseHeight = 220; const dynamicHeight = (cartItems.length * lineHeight) + baseHeight; canvas.height = dynamicHeight; canvas.width = canvasWidth; ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = '#000000'; ctx.font = 'bold 16px "Courier New", monospace'; ctx.textAlign = 'center'; ctx.fillText('TICKET DE VENTA', canvasWidth / 2, currentY); currentY += lineHeight * 1.5; ctx.font = '11px "Courier New", monospace'; ctx.fillText(new Date().toLocaleString('es-MX'), canvasWidth / 2, currentY); currentY += lineHeight * 1.5; ctx.fillText('-'.repeat(40), canvasWidth / 2, currentY); currentY += lineHeight; ctx.textAlign = 'left'; ctx.font = 'bold 11px "Courier New", monospace'; ctx.fillText('Cant. Producto', padding, currentY); ctx.textAlign = 'right'; ctx.fillText('Total', canvasWidth - padding, currentY); currentY += lineHeight * 0.5; ctx.textAlign = 'center'; ctx.fillText('-'.repeat(40), canvasWidth / 2, currentY); currentY += lineHeight; ctx.font = '11px "Courier New", monospace'; cartItems.forEach(item => { ctx.textAlign = 'left'; const name = item.producto.length > 28 ? item.producto.substring(0, 25) + '...' : item.producto; ctx.fillText(`${item.quantity} x ${name}`, padding, currentY); ctx.textAlign = 'right'; ctx.fillText(new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(item.precio_venta * item.quantity), canvasWidth - padding, currentY); currentY += lineHeight; }); ctx.textAlign = 'center'; ctx.fillText('-'.repeat(40), canvasWidth / 2, currentY); currentY += lineHeight; const subtotal = cartItems.reduce((acc, item) => acc + (item.precio_venta * item.quantity), 0); const tax = subtotal * 0.16; const total = subtotal + tax; const paid = parseFloat(paymentInput.value) || 0; const change = paid - total; ctx.textAlign = 'right'; ctx.font = '12px "Courier New", monospace'; ctx.fillText(`Subtotal: ${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(subtotal)}`, canvasWidth - padding, currentY); currentY += lineHeight; ctx.fillText(`IVA (16%): ${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(tax)}`, canvasWidth - padding, currentY); currentY += lineHeight; ctx.font = 'bold 14px "Courier New", monospace'; ctx.fillText(`TOTAL: ${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(total)}`, canvasWidth - padding, currentY); currentY += lineHeight * 1.5; ctx.font = '12px "Courier New", monospace'; ctx.fillText(`Paga con: ${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(paid)}`, canvasWidth - padding, currentY); currentY += lineHeight; ctx.fillText(`Cambio: ${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(change > 0 ? change : 0)}`, canvasWidth - padding, currentY); currentY += lineHeight * 2; const folio = `VTA-${Date.now()}`; drawBarcode(ctx, folio, canvasWidth / 2 - 100, currentY, 200, 40); currentY += 55; ctx.textAlign = 'center'; ctx.font = 'bold 12px "Courier New", monospace'; ctx.fillText('¡Gracias por su compra!', canvasWidth / 2, currentY); }
            function drawBarcode(ctx, text, x, y, width, height) { let currentX = x; for (let i = 0; i < text.length; i++) { if (Math.random() > 0.5) { const barWidth = Math.random() * (width / text.length - 2) + 2; ctx.fillRect(currentX, y, barWidth, height); } currentX += (width / text.length); } ctx.font = '12px "Courier New", monospace'; ctx.textAlign = 'center'; ctx.fillText(text, x + width / 2, y + height + 15); }
            
            document.getElementById('promo-toggle').addEventListener('change', (e) => {
                const promoDetails = document.getElementById('promo-details');
                promoDetails.classList.toggle('open', e.target.checked);
                if (e.target.checked) {
                    openModal('promo-search-modal');
                    const searchInput = document.getElementById('modal-promo-search-input');
                    searchInput.value = '';
                    document.getElementById('modal-promo-search-results').innerHTML = '<p class="text-slate-500 text-center p-4">Escribe para buscar un producto.</p>';
                    setTimeout(() => searchInput.focus(), 100);
                } else {
                    selectedPromoProduct = null;
                    const container = document.getElementById('selected-promo-product');
                    container.innerHTML = '';
                    container.classList.add('hidden');
                }
            });

            document.getElementById('modal-promo-search-input').addEventListener('input', (e) => {
                const resultsContainer = document.getElementById('modal-promo-search-results');
                const term = e.target.value.toLowerCase().trim();
                if (term.length < 2) {
                    resultsContainer.innerHTML = '<p class="text-slate-500 text-center p-4">Escribe al menos 2 letras...</p>';
                    return;
                }
                const results = allProducts.filter(p => !p.isPromo && (p.producto.toLowerCase().includes(term) || p.codigo.toLowerCase().includes(term) || (p.tags || '').toLowerCase().includes(term)));
                if (results.length > 0) {
                    resultsContainer.innerHTML = results.slice(0, 10).map(p => `
                        <div class="flex items-center gap-3 p-2 hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer promo-select-btn rounded-md" data-key="${p.key}">
                            <img src="${p.imagen_url}" class="w-10 h-10 object-cover rounded-md flex-shrink-0" />
                            <div class="flex-grow min-w-0">
                                <p class="font-semibold text-sm truncate text-slate-800 dark:text-slate-200">${p.producto}</p>
                                <p class="text-xs text-slate-500">${p.codigo}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    resultsContainer.innerHTML = '<p class="text-slate-500 text-center p-4">No se encontraron productos.</p>';
                }
            });

            document.getElementById('modal-promo-search-results').addEventListener('click', (e) => {
                const productDiv = e.target.closest('.promo-select-btn');
                if (productDiv) {
                    const product = allProducts.find(p => p.key === productDiv.dataset.key);
                    if(product) {
                        selectPromoProduct(product);
                        closeModal('promo-search-modal');
                    }
                }
            });

            document.getElementById('close-promo-search-modal-btn').addEventListener('click', () => {
                closeModal('promo-search-modal');
                if (!selectedPromoProduct) {
                    document.getElementById('promo-toggle').checked = false;
                    document.getElementById('promo-details').classList.remove('open');
                }
            });

            function selectPromoProduct(product) { selectedPromoProduct = product; const container = document.getElementById('selected-promo-product'); container.innerHTML = `<img src="${product.imagen_url}" class="w-10 h-10 object-cover rounded-md flex-shrink-0" /><div class="flex-grow min-w-0"><p class="font-semibold text-sm truncate">${product.producto}</p><p class="text-xs text-slate-500">${product.codigo}</p></div><button type="button" id="remove-promo-product" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>`; container.classList.remove('hidden'); container.classList.add('flex'); document.getElementById('remove-promo-product').addEventListener('click', () => { selectedPromoProduct = null; container.innerHTML = ''; container.classList.add('hidden'); document.getElementById('promo-toggle').checked = false; document.getElementById('promo-details').classList.remove('open'); }); }

            function renderProfileView(user) {
                if (currentUserRole === 'admin') {
                    renderAdminDashboard();
                } else if (currentUserRole === 'employee') {
                    renderEmployeeDashboard(user);
                }
            }

            function renderAdminDashboard() {
                perfilView.innerHTML = `
                    <div id="admin-main-dashboard">
                        <h2 class="text-2xl font-bold mb-6">Panel de Administrador</h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                            <button data-action="view-tickets" class="admin-action-btn p-4 bg-blue-500 text-white rounded-lg shadow-md flex flex-col items-center justify-center aspect-square"><svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path></svg><span class="text-sm font-semibold text-center">Ver Tickets</span></button>
                            <button data-action="low-stock" class="admin-action-btn p-4 bg-yellow-500 text-white rounded-lg shadow-md flex flex-col items-center justify-center aspect-square"><svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg><span class="text-sm font-semibold text-center">Bajo Stock</span></button>
                            <button data-action="add-expense" class="admin-action-btn p-4 bg-red-500 text-white rounded-lg shadow-md flex flex-col items-center justify-center aspect-square"><svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6"></path></svg><span class="text-sm font-semibold text-center">Agregar Gasto</span></button>
                            <button data-action="add-income" class="admin-action-btn p-4 bg-green-500 text-white rounded-lg shadow-md flex flex-col items-center justify-center aspect-square"><svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg><span class="text-sm font-semibold text-center">Añadir Ingreso</span></button>
                            <button data-action="manage-employees" class="admin-action-btn p-4 bg-indigo-500 text-white rounded-lg shadow-md flex flex-col items-center justify-center aspect-square"><svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><span class="text-sm font-semibold text-center">Administrar Empleados</span></button>
                            <button data-action="payroll" class="admin-action-btn p-4 bg-gray-500 text-white rounded-lg shadow-md flex flex-col items-center justify-center aspect-square"><svg class="w-8 h-8 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span class="text-sm font-semibold text-center">Nómina</span></button>
                        </div>
                    </div>
                    <div id="admin-content-view" class="hidden"></div>
                `;

                document.querySelectorAll('.admin-action-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const action = e.currentTarget.dataset.action;
                        const adminMainDashboard = document.getElementById('admin-main-dashboard');
                        const adminContentView = document.getElementById('admin-content-view');

                        const showAdminContent = (title, content) => {
                            adminMainDashboard.classList.add('hidden');
                            adminContentView.classList.remove('hidden');
                            adminContentView.innerHTML = `
                                <div class="flex items-center justify-between mb-6">
                                    <h2 class="text-2xl font-bold">${title}</h2>
                                    <button id="back-to-admin-dashboard" class="flex items-center gap-2 text-slate-600 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-500 font-semibold"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>Volver</button>
                                </div>
                                ${content}
                            `;
                            document.getElementById('back-to-admin-dashboard').addEventListener('click', () => {
                                adminContentView.classList.add('hidden');
                                adminMainDashboard.classList.remove('hidden');
                            });
                        };

                        switch (action) {
                            case 'view-tickets':
                                showAdminContent('Todos los Tickets de Venta', renderTicketsList());
                                break;
                            case 'low-stock':
                                showAdminContent('Productos con Bajo Stock', renderLowStockList());
                                break;
                            case 'add-expense':
                                openModal('expense-modal');
                                break;
                            case 'add-income':
                                openModal('income-modal');
                                break;
                            case 'manage-employees':
                                showAdminContent('Administrar Empleados', renderEmployeeList());
                                break;
                            case 'payroll':
                                renderPayrollReport();
                                break;
                        }
                    });
                });
            }
            
            // Admin Panel Functions
            const renderTicketsList = () => {
                if (allSales.length === 0) return '<p class="text-slate-500">No hay ventas registradas.</p>';
                const salesByDate = [...allSales].sort((a, b) => b.timestamp - a.timestamp);
                return `<div class="bg-white dark:bg-slate-800 rounded-lg shadow-md overflow-hidden"><ul class="divide-y divide-slate-200 dark:divide-slate-700">${salesByDate.map(sale => {
                    const sellerEmail = allUsers[sale.sellerId]?.email || 'Desconocido';
                    return `<li class="p-4"><div class="flex justify-between items-center"><div><p class="font-bold text-lg">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(sale.total)}</p><p class="text-sm text-slate-500">Vendido por: ${sellerEmail}</p></div><p class="text-sm text-slate-400">${new Date(sale.timestamp).toLocaleString('es-MX')}</p></div><div class="mt-2 text-sm">${sale.items.map(i => `<span>${i.quantity}x ${i.producto}</span>`).join(', ')}</div></li>`
                }).join('')}</ul></div>`;
            };

            const renderLowStockList = (threshold = 10) => {
                const lowStockProducts = allProducts.filter(p => !p.isPromo && p.stock < threshold).sort((a,b) => a.stock - b.stock);
                if (lowStockProducts.length === 0) return `<p class="text-slate-500">No hay productos con bajo stock (menos de ${threshold} unidades).</p>`;
                return `<div class="bg-white dark:bg-slate-800 rounded-lg shadow-md overflow-hidden"><table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700"><thead class="bg-slate-50 dark:bg-slate-700"><tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Producto</th><th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Stock Restante</th></tr></thead><tbody class="divide-y divide-slate-200 dark:divide-slate-700">${lowStockProducts.map(p => `<tr><td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-slate-900 dark:text-white">${p.producto}</div><div class="text-sm text-slate-500 dark:text-slate-400">${p.codigo}</div></td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-bold text-yellow-500">${p.stock}</td></tr>`).join('')}</tbody></table></div>`;
            };
            
            const renderEmployeeList = () => {
                const employees = Object.entries(allUsers).filter(([uid, user]) => user.role === 'employee');
                let content = `<div class="flex justify-end mb-4"><button id="add-employee-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Agregar Empleado</button></div>`;
                if (employees.length === 0) {
                    content += '<p class="text-slate-500">No hay empleados registrados.</p>';
                } else {
                    content += `<div class="bg-white dark:bg-slate-800 rounded-lg shadow-md overflow-hidden"><ul class="divide-y divide-slate-200 dark:divide-slate-700">${employees.map(([uid, user]) => `
                        <li class="p-4 flex flex-wrap justify-between items-center gap-4">
                            <div>
                                <p class="font-semibold">${user.email}</p>
                                <p class="text-sm text-slate-500">Salario Base: ${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(user.baseSalary || 0)}</p>
                            </div>
                            <div class="flex gap-2">
                                <button class="edit-employee-btn text-sm text-blue-500 hover:underline" data-uid="${uid}">Editar</button>
                                <button class="view-performance-btn text-sm text-purple-500 hover:underline" data-uid="${uid}">Desempeño</button>
                            </div>
                        </li>`).join('')}</ul></div>`;
                }
                
                setTimeout(() => {
                    document.getElementById('add-employee-btn')?.addEventListener('click', () => openEmployeeModal('add'));
                    document.querySelectorAll('.edit-employee-btn').forEach(btn => btn.addEventListener('click', (e) => openEmployeeModal('edit', e.target.dataset.uid)));
                    document.querySelectorAll('.view-performance-btn').forEach(btn => btn.addEventListener('click', (e) => showView('desempeno-vendedor-view', {uid: e.target.dataset.uid})));
                }, 0);

                return content;
            };

            const openEmployeeModal = (mode, uid = null) => {
                const form = document.getElementById('employee-form');
                form.reset();
                document.getElementById('employee-id').value = '';
                const passwordInput = document.getElementById('employee-password');
                const modalTitle = document.getElementById('employee-modal-title');

                if (mode === 'edit') {
                    const user = allUsers[uid];
                    modalTitle.textContent = 'Editar Empleado';
                    document.getElementById('employee-id').value = uid;
                    document.getElementById('employee-email').value = user.email;
                    document.getElementById('employee-email').disabled = true;
                    document.getElementById('employee-base-salary').value = user.baseSalary || 0;
                    passwordInput.placeholder = "Dejar en blanco para no cambiar";
                    passwordInput.required = false;
                } else {
                    modalTitle.textContent = 'Agregar Empleado';
                    document.getElementById('employee-email').disabled = false;
                    passwordInput.placeholder = "Contraseña Temporal";
                    passwordInput.required = true;
                }
                openModal('employee-modal');
            };

            const renderPayrollReport = () => {
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];

                const content = `
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md mb-6">
                        <div class="flex flex-wrap gap-4 items-center justify-between">
                            <div class="flex gap-4">
                                <div>
                                    <label for="payroll-start-date" class="text-sm font-medium">Desde:</label>
                                    <input type="date" id="payroll-start-date" value="${firstDayOfMonth}" class="p-2 border rounded-md dark:bg-slate-700 dark:border-slate-600">
                                </div>
                                <div>
                                    <label for="payroll-end-date" class="text-sm font-medium">Hasta:</label>
                                    <input type="date" id="payroll-end-date" value="${lastDayOfMonth}" class="p-2 border rounded-md dark:bg-slate-700 dark:border-slate-600">
                                </div>
                            </div>
                            <button id="export-payroll-csv" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                Exportar CSV
                            </button>
                        </div>
                    </div>
                    <div id="payroll-kpis" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"></div>
                    <div id="payroll-table-container" class="overflow-x-auto bg-white dark:bg-slate-800 rounded-lg shadow-md"></div>
                    <div id="payroll-pending" class="mt-6 bg-white dark:bg-slate-800 p-4 rounded-lg shadow"></div>
                    <div class="mt-6 bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-2">Tendencia de Nómina</h3>
                        <canvas id="payroll-trend-chart"></canvas>
                    </div>
                `;
                
                showView('payroll-view');
                payrollView.innerHTML = `
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold">Reporte de Nómina</h2>
                        <button id="back-to-admin-dashboard" class="flex items-center gap-2 text-slate-600 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-500 font-semibold"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>Volver</button>
                    </div>
                    ${content}
                `;
                
                const updateReport = () => {
                    const startDate = new Date(document.getElementById('payroll-start-date').value + 'T00:00:00');
                    const endDate = new Date(document.getElementById('payroll-end-date').value + 'T23:59:59');
                    generatePayrollTable(startDate, endDate);
                    renderPayrollKPIs(startDate, endDate);
                    renderPayrollTrendChart(startDate, endDate);
                    renderPendingPayments(startDate, endDate);
                };

                document.getElementById('back-to-admin-dashboard').addEventListener('click', () => {
                    showView('perfil-view');
                });
                document.getElementById('payroll-start-date').addEventListener('change', updateReport);
                document.getElementById('payroll-end-date').addEventListener('change', updateReport);
                document.getElementById('export-payroll-csv').addEventListener('click', () => {
                    const startDate = new Date(document.getElementById('payroll-start-date').value + 'T00:00:00');
                    const endDate = new Date(document.getElementById('payroll-end-date').value + 'T23:59:59');
                    exportPayrollToCSV(startDate, endDate);
                });
                updateReport();
            };
            
            window.showSellerPerformance = (uid) => showView('desempeno-vendedor-view', {uid});

            // Event Listeners for Admin Modals
            document.getElementById('cancel-expense-btn').addEventListener('click', () => closeModal('expense-modal'));
            document.getElementById('expense-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const description = document.getElementById('expense-description').value;
                const amount = parseFloat(document.getElementById('expense-amount').value);
                const category = document.getElementById('expense-category').value;
                if (description && amount > 0 && category) {
                    push(ref(db, 'gastos'), { description, amount, category, timestamp: Date.now() });
                    showToast('Gasto registrado con éxito.');
                    closeModal('expense-modal');
                    e.target.reset();
                }
            });

            document.getElementById('cancel-income-btn').addEventListener('click', () => closeModal('income-modal'));
            document.getElementById('income-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const description = document.getElementById('income-description').value;
                const amount = parseFloat(document.getElementById('income-amount').value);
                const category = document.getElementById('income-category').value;
                if (description && amount > 0 && category) {
                    push(ref(db, 'ingresos'), { description, amount, category, timestamp: Date.now() });
                    showToast('Ingreso registrado con éxito.');
                    closeModal('income-modal');
                    e.target.reset();
                }
            });

            document.getElementById('transaction-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const type = document.getElementById('transaction-type').value;
                const employeeId = document.getElementById('transaction-employee-id').value;
                const description = document.getElementById('transaction-description').value;
                const amount = parseFloat(document.getElementById('transaction-amount').value);

                if (description && amount > 0 && employeeId && type) {
                    const path = `transactions/${type}`;
                    push(ref(db, path), { employeeId, description, amount, timestamp: Date.now() });
                    showToast(`${type === 'bonuses' ? 'Bono' : 'Deducción'} registrado con éxito.`);
                    closeModal('transaction-modal');
                    e.target.reset();
                }
            });
            document.querySelector('#transaction-modal .cancel-btn').addEventListener('click', () => closeModal('transaction-modal'));
            
            document.getElementById('cancel-employee-btn').addEventListener('click', () => closeModal('employee-modal'));
            document.getElementById('employee-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('employee-email').value;
                const password = document.getElementById('employee-password').value;
                const baseSalary = parseFloat(document.getElementById('employee-base-salary').value);
                const uid = document.getElementById('employee-id').value;

                if (uid) { // Editing existing employee
                    const updates = {
                        email: email,
                        baseSalary: baseSalary
                    };
                    update(ref(db, 'users/' + uid), updates).then(() => {
                        showToast('Empleado actualizado.');
                        closeModal('employee-modal');
                        renderAdminDashboard(); // Refresh view
                    }).catch(err => showToast('Error al actualizar: ' + err.message, true));
                } else { // Creating new employee
                    showConfirmation(
                        'Confirmar Creación de Empleado',
                        'Esta acción creará un nuevo usuario y podría requerir que inicies sesión de nuevo. ¿Deseas continuar?',
                        async () => {
                            try {
                                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                                const user = userCredential.user;
                                await set(ref(db, 'users/' + user.uid), {
                                    email: user.email,
                                    role: 'employee',
                                    baseSalary: baseSalary
                                });
                                showToast('Empleado creado con éxito.');
                                closeModal('employee-modal');
                                e.target.reset();
                            } catch (error) {
                                console.error("Error creating employee:", error);
                                showToast(`Error: ${error.message}`, true);
                            }
                        }
                    );
                }
            });

            document.getElementById('cancel-payment-btn')?.addEventListener('click', () => closeModal('payment-modal'));
            document.getElementById('payment-form')?.addEventListener('submit', (e) => {
                e.preventDefault();
                const employeeId = document.getElementById('payment-employee-id').value;
                const description = document.getElementById('payment-description').value;
                const amount = parseFloat(document.getElementById('payment-amount').value);

                if (employeeId && description && amount > 0) {
                    push(ref(db, 'payrollPayments'), {
                        employeeId,
                        description,
                        amount,
                        timestamp: Date.now()
                    }).then(() => {
                        showToast('Pago registrado con éxito.');
                        closeModal('payment-modal');
                        e.target.reset();
                        if(document.getElementById('payroll-view').classList.contains('active')) {
                            renderPayrollReport();
                        }
                    }).catch(err => showToast('Error al registrar pago.', true));
                }
            });
            document.getElementById('close-payment-history-btn')?.addEventListener('click', () => closeModal('payment-history-modal'));

            // Payroll and Performance Functions
            function generatePayrollTable(startDate, endDate) {
                const tableContainer = document.getElementById('payroll-table-container');
                const employees = Object.entries(allUsers).filter(([_, user]) => user.role === 'employee');
                
                if (employees.length === 0) {
                    tableContainer.innerHTML = '<p class="text-slate-500 p-4">No hay empleados registrados.</p>';
                    return;
                }

                let tableHTML = `
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                        <thead class="bg-slate-50 dark:bg-slate-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Empleado</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Salario Base</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Bonos</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Deducciones</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Pagos</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Total Neto</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-300 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                `;

                employees.forEach(([uid, user]) => {
                    const bonuses = allTransactions.bonuses
                        .filter(t => t.employeeId === uid && t.timestamp >= startDate.getTime() && t.timestamp <= endDate.getTime())
                        .reduce((sum, t) => sum + t.amount, 0);
                    const deductions = allTransactions.deductions
                        .filter(t => t.employeeId === uid && t.timestamp >= startDate.getTime() && t.timestamp <= endDate.getTime())
                        .reduce((sum, t) => sum + t.amount, 0);
                    const payments = allPayrollPayments
                        .filter(p => p.employeeId === uid && p.timestamp >= startDate.getTime() && p.timestamp <= endDate.getTime())
                        .reduce((sum, p) => sum + p.amount, 0);
                    const baseSalary = user.baseSalary || 0;
                    const netTotal = baseSalary + bonuses - deductions - payments;

                    tableHTML += `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900 dark:text-white">${user.email}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-mono">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(baseSalary)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-mono text-green-500">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(bonuses)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-mono text-red-500">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(deductions)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-mono">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(payments)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-mono font-bold ${netTotal < 0 ? 'text-red-500' : 'text-blue-500'}">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(netTotal)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-right">
                                <button class="add-bonus-btn text-blue-500 hover:underline" data-uid="${uid}">Bono</button>
                                <button class="add-deduction-btn text-red-500 hover:underline" data-uid="${uid}">Deducción</button>
                                <button class="pay-salary-btn text-green-500 hover:underline" data-uid="${uid}" data-amount="${netTotal > 0 ? netTotal : 0}">Pagar</button>
                                <button class="view-payment-history-btn text-purple-500 hover:underline" data-uid="${uid}">Historial</button>
                            </td>
                        </tr>
                    `;
                });

                tableHTML += '</tbody></table>';
                tableContainer.innerHTML = tableHTML;

                // Add event listeners for action buttons
                tableContainer.querySelectorAll('.add-bonus-btn').forEach(btn => {
                    btn.addEventListener('click', () => openTransactionModal('bonuses', btn.dataset.uid));
                });
                tableContainer.querySelectorAll('.add-deduction-btn').forEach(btn => {
                    btn.addEventListener('click', () => openTransactionModal('deductions', btn.dataset.uid));
                });
                tableContainer.querySelectorAll('.pay-salary-btn').forEach(btn => {
                    btn.addEventListener('click', () => openPaymentModal(btn.dataset.uid, btn.dataset.amount));
                });
                tableContainer.querySelectorAll('.view-payment-history-btn').forEach(btn => {
                    btn.addEventListener('click', () => showPaymentHistory(btn.dataset.uid));
                });
            }

            function renderPayrollKPIs(startDate, endDate) {
                const kpisContainer = document.getElementById('payroll-kpis');
                const employees = Object.entries(allUsers).filter(([_, user]) => user.role === 'employee');

                const totalBaseSalaries = employees.reduce((sum, [_, user]) => sum + (user.baseSalary || 0), 0);
                const totalBonuses = allTransactions.bonuses
                    .filter(t => t.timestamp >= startDate.getTime() && t.timestamp <= endDate.getTime())
                    .reduce((sum, t) => sum + t.amount, 0);
                const totalDeductions = allTransactions.deductions
                    .filter(t => t.timestamp >= startDate.getTime() && t.timestamp <= endDate.getTime())
                    .reduce((sum, t) => sum + t.amount, 0);
                const totalPayments = allPayrollPayments
                    .filter(p => p.timestamp >= startDate.getTime() && p.timestamp <= endDate.getTime())
                    .reduce((sum, p) => sum + p.amount, 0);
                const pendingPayments = employees.reduce((sum, [uid, user]) => {
                    const bonuses = allTransactions.bonuses
                        .filter(t => t.employeeId === uid && t.timestamp >= startDate.getTime() && t.timestamp <= endDate.getTime())
                        .reduce((sum, t) => sum + t.amount, 0);
                    const deductions = allTransactions.deductions
                        .filter(t => t.employeeId === uid && t.timestamp >= startDate.getTime() && t.timestamp <= endDate.getTime())
                        .reduce((sum, t) => sum + t.amount, 0);
                    const payments = allPayrollPayments
                        .filter(p => p.employeeId === uid && p.timestamp >= startDate.getTime() && p.timestamp <= endDate.getTime())
                        .reduce((sum, p) => sum + p.amount, 0);
                    const netTotal = (user.baseSalary || 0) + bonuses - deductions - payments;
                    return sum + (netTotal > 0 ? netTotal : 0);
                }, 0);

                kpisContainer.innerHTML = `
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                        <p class="text-sm text-slate-500">Total Salarios Base</p>
                        <p class="text-2xl font-bold">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(totalBaseSalaries)}</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                        <p class="text-sm text-slate-500">Total Bonos</p>
                        <p class="text-2xl font-bold text-green-500">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(totalBonuses)}</p>
                    </div>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                        <p class="text-sm text-slate-500">Total Deducciones</p>
                        <p class="text-2xl font-bold text-red-500">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(totalDeductions)}</p>
                    </div>
                `;
            }

            function renderPayrollTrendChart(startDate, endDate) {
                if (payrollChart) {
                    payrollChart.destroy();
                }
                const ctx = document.getElementById('payroll-trend-chart')?.getContext('2d');
                if (!ctx) return;

                const paymentsByMonth = {};
                allPayrollPayments
                    .filter(p => p.timestamp >= startDate.getTime() && p.timestamp <= endDate.getTime())
                    .forEach(p => {
                        const date = new Date(p.timestamp);
                        const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                        if (!paymentsByMonth[monthKey]) paymentsByMonth[monthKey] = 0;
                        paymentsByMonth[monthKey] += p.amount;
                    });

                const labels = Object.keys(paymentsByMonth).sort();
                const data = labels.map(key => paymentsByMonth[key]);

                payrollChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels.map(k => new Date(k + '-02').toLocaleString('es-MX', { month: 'short', year: 'numeric' })),
                        datasets: [{
                            label: 'Pagos de Nómina',
                            data: data,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Monto (MXN)' } },
                            x: { title: { display: true, text: 'Mes' } }
                        }
                    }
                });
            }

            function renderPendingPayments(startDate, endDate) {
                const pendingContainer = document.getElementById('payroll-pending');
                const employees = Object.entries(allUsers).filter(([_, user]) => user.role === 'employee');
                let pendingHTML = '<h3 class="text-xl font-bold mb-2">Pagos Pendientes</h3>';

                const pendingPayments = employees.map(([uid, user]) => {
                    const bonuses = allTransactions.bonuses
                        .filter(t => t.employeeId === uid && t.timestamp >= startDate.getTime() && t.timestamp <= endDate.getTime())
                        .reduce((sum, t) => sum + t.amount, 0);
                    const deductions = allTransactions.deductions
                        .filter(t => t.employeeId === uid && t.timestamp >= startDate.getTime() && t.timestamp <= endDate.getTime())
                        .reduce((sum, t) => sum + t.amount, 0);
                    const payments = allPayrollPayments
                        .filter(p => p.employeeId === uid && p.timestamp >= startDate.getTime() && p.timestamp <= endDate.getTime())
                        .reduce((sum, p) => sum + p.amount, 0);
                    const netTotal = (user.baseSalary || 0) + bonuses - deductions - payments;
                    return { email: user.email, pending: netTotal, uid };
                }).filter(p => p.pending > 0);

                if (pendingPayments.length === 0) {
                    pendingHTML += '<p class="text-slate-500">No hay pagos pendientes.</p>';
                } else {
                    pendingHTML += `
                        <ul class="divide-y divide-slate-200 dark:divide-slate-700">
                            ${pendingPayments.map(p => `
                                <li class="py-2 flex justify-between items-center">
                                    <span>${p.email}</span>
                                    <div class="flex gap-2 items-center">
                                        <span class="font-mono text-yellow-500">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(p.pending)}</span>
                                        <button class="pay-salary-btn text-green-500 hover:underline" data-uid="${p.uid}" data-amount="${p.pending}">Pagar</button>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    `;
                }

                pendingContainer.innerHTML = pendingHTML;

                pendingContainer.querySelectorAll('.pay-salary-btn').forEach(btn => {
                    btn.addEventListener('click', () => openPaymentModal(btn.dataset.uid, btn.dataset.amount));
                });
            }

            function exportPayrollToCSV(startDate, endDate) {
                const employees = Object.entries(allUsers).filter(([_, user]) => user.role === 'employee');
                let csv = 'Correo,Salario Base,Bonos,Deducciones,Pagos,Total Neto\n';

                employees.forEach(([uid, user]) => {
                    const bonuses = allTransactions.bonuses
                        .filter(t => t.employeeId === uid && t.timestamp >= startDate.getTime() && t.timestamp <= endDate.getTime())
                        .reduce((sum, t) => sum + t.amount, 0);
                    const deductions = allTransactions.deductions
                        .filter(t => t.employeeId === uid && t.timestamp >= startDate.getTime() && t.timestamp <= endDate.getTime())
                        .reduce((sum, t) => sum + t.amount, 0);
                    const payments = allPayrollPayments
                        .filter(p => p.employeeId === uid && p.timestamp >= startDate.getTime() && p.timestamp <= endDate.getTime())
                        .reduce((sum, p) => sum + p.amount, 0);
                    const baseSalary = user.baseSalary || 0;
                    const netTotal = baseSalary + bonuses - deductions - payments;

                    csv += `"${user.email}",${baseSalary},${bonuses},${deductions},${payments},${netTotal}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `nomina_${startDate.toISOString().split('T')[0]}_${endDate.toISOString().split('T')[0]}.csv`;
                link.click();
            }

            function openTransactionModal(type, employeeId) {
                const modalTitle = document.getElementById('transaction-modal-title');
                const submitBtn = document.querySelector('#transaction-modal .submit-btn');
                modalTitle.textContent = type === 'bonuses' ? 'Agregar Bono' : 'Agregar Deducción';
                submitBtn.className = `submit-btn px-4 py-2 text-white rounded-md ${type === 'bonuses' ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}`;
                document.getElementById('transaction-type').value = type;
                document.getElementById('transaction-employee-id').value = employeeId;
                document.getElementById('transaction-form').reset();
                openModal('transaction-modal');
            }

            function openPaymentModal(employeeId, amount = '') {
                document.getElementById('payment-employee-id').value = employeeId;
                document.getElementById('payment-form').reset();
                document.getElementById('payment-amount').value = amount;
                document.getElementById('payment-description').value = `Pago de Nómina - ${new Date().toLocaleString('es-MX')}`;
                openModal('payment-modal');
            }

            function showPaymentHistory(employeeId) {
                const modalTitle = document.getElementById('payment-history-title');
                const contentContainer = document.getElementById('payment-history-content');
                const employee = allUsers[employeeId];
                modalTitle.textContent = `Historial de Pagos: ${employee.email}`;
                
                const payments = allPayrollPayments
                    .filter(p => p.employeeId === employeeId)
                    .sort((a, b) => b.timestamp - a.timestamp);
                
                if (payments.length === 0) {
                    contentContainer.innerHTML = '<p class="text-slate-500 p-4">No hay pagos registrados.</p>';
                } else {
                    contentContainer.innerHTML = `
                        <ul class="divide-y divide-slate-200 dark:divide-slate-700">
                            ${payments.map(p => `
                                <li class="py-2 flex justify-between items-center">
                                    <div>
                                        <p class="font-semibold">${p.description}</p>
                                        <p class="text-sm text-slate-500">${new Date(p.timestamp).toLocaleString('es-MX')}</p>
                                    </div>
                                    <span class="font-mono text-green-500">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(p.amount)}</span>
                                </li>
                            `).join('')}
                        </ul>
                    `;
                }
                openModal('payment-history-modal');
            }

            function renderEmployeeDashboard(user) {
                const mySales = allSales.filter(sale => sale.sellerId === user.uid);
                const totalVendido = mySales.reduce((acc, sale) => acc + sale.total, 0);
                const totalGanancia = mySales.reduce((acc, sale) => {
                    const gananciaVenta = sale.items.reduce((itemAcc, item) => {
                        return itemAcc + ((item.precio_venta - item.precio_compra) * item.quantity);
                    }, 0);
                    return acc + gananciaVenta;
                }, 0);

                let productosVendidosHTML = mySales.flatMap(sale => sale.items).map(item => `
                    <li class="flex justify-between items-center py-2 border-b border-slate-200 dark:border-slate-700">
                        <span>${item.quantity} x ${item.producto}</span>
                        <span class="font-mono">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(item.precio_venta * item.quantity)}</span>
                    </li>
                `).join('');

                perfilView.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4">Tu Desempeño</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow"><p class="text-sm text-slate-500">Ventas Totales</p><p class="text-2xl font-bold">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(totalVendido)}</p></div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow"><p class="text-sm text-slate-500">Ganancia Total</p><p class="text-2xl font-bold text-green-500">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(totalGanancia)}</p></div>
                    </div>
                    <div><h3 class="text-xl font-bold mb-2">Productos Vendidos</h3><ul class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">${productosVendidosHTML || '<p class="text-slate-500">Aún no has vendido productos.</p>'}</ul></div>
                `;
            }

            function renderSellerPerformanceView(uid) {
                const seller = allUsers[uid];
                if (!seller) {
                    desempenoVendedorView.innerHTML = `<p>Empleado no encontrado.</p>`;
                    return;
                }

                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];

                desempenoVendedorView.innerHTML = `
                    <div class="mb-6 flex justify-between items-center">
                        <button id="back-to-admin-panel" class="flex items-center gap-2 text-slate-600 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-500 font-semibold">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                            Volver al Panel
                        </button>
                    </div>
                    <h2 class="text-2xl font-bold mb-4">Desempeño de: <span class="text-blue-500">${seller.email}</span></h2>
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow-md mb-6">
                        <div class="flex flex-wrap gap-4 items-center">
                            <div><label for="perf-start-date" class="text-sm font-medium">Desde:</label><input type="date" id="perf-start-date" value="${firstDayOfMonth}" class="p-2 border rounded-md dark:bg-slate-700 dark:border-slate-600"></div>
                            <div><label for="perf-end-date" class="text-sm font-medium">Hasta:</label><input type="date" id="perf-end-date" value="${lastDayOfMonth}" class="p-2 border rounded-md dark:bg-slate-700 dark:border-slate-600"></div>
                        </div>
                    </div>
                    <div id="performance-content"></div>
                `;

                const updatePerformanceView = () => {
                    const startDate = new Date(document.getElementById('perf-start-date').value + 'T00:00:00');
                    const endDate = new Date(document.getElementById('perf-end-date').value + 'T23:59:59');
                    
                    const sellerSales = allSales.filter(sale => sale.sellerId === uid && sale.timestamp >= startDate.getTime() && sale.timestamp <= endDate.getTime());
                    const totalVendido = sellerSales.reduce((acc, sale) => acc + sale.total, 0);
                    const totalGanancia = sellerSales.reduce((acc, sale) => acc + sale.items.reduce((itemAcc, item) => itemAcc + ((item.precio_venta - item.precio_compra) * item.quantity), 0), 0);
                    const transactionCount = sellerSales.length;
                    const promoSalesCount = sellerSales.filter(sale => sale.items.some(item => item.isPromo)).length;
                    const promoRate = transactionCount > 0 ? (promoSalesCount / transactionCount) * 100 : 0;

                    const bonuses = allTransactions.bonuses.filter(t => t.employeeId === uid && t.timestamp >= startDate.getTime() && t.timestamp <= endDate.getTime());
                    const deductions = allTransactions.deductions.filter(t => t.employeeId === uid && t.timestamp >= startDate.getTime() && t.timestamp <= endDate.getTime());

                    const productSales = {};
                    sellerSales.forEach(sale => {
                        sale.items.forEach(item => {
                            if (!productSales[item.producto]) productSales[item.producto] = { quantity: 0, total: 0 };
                            productSales[item.producto].quantity += item.quantity;
                            productSales[item.producto].total += item.precio_venta * item.quantity;
                        });
                    });
                    const topProducts = Object.entries(productSales).map(([producto, data]) => ({ producto, ...data })).sort((a, b) => b.quantity - a.quantity).slice(0, 5);
                    
                    document.getElementById('performance-content').innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow"><p class="text-sm text-slate-500">Ventas Totales</p><p class="text-2xl font-bold">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(totalVendido)}</p></div>
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow"><p class="text-sm text-slate-500">Ganancia Neta</p><p class="text-2xl font-bold text-emerald-500">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(totalGanancia)}</p></div>
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow"><p class="text-sm text-slate-500">Transacciones</p><p class="text-2xl font-bold">${transactionCount}</p></div>
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow"><p class="text-sm text-slate-500">Tasa de Venta Promo</p><p class="text-2xl font-bold">${promoRate.toFixed(1)}%</p></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                                <h3 class="text-xl font-bold mb-2">Productos Más Vendidos</h3>
                                <ul class="divide-y divide-slate-200 dark:divide-slate-700">${topProducts.length > 0 ? topProducts.map(p => `<li class="flex justify-between items-center py-2"><span>${p.quantity} x ${p.producto}</span><span class="font-mono">${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(p.total)}</span></li>`).join('') : '<p class="text-slate-500">No hay productos vendidos.</p>'}</ul>
                            </div>
                            <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                                <h3 class="text-xl font-bold mb-2">Bonos y Deducciones</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><p class="text-sm text-slate-500">Bonos</p><ul>${bonuses.length > 0 ? bonuses.map(b => `<li class="text-sm">${b.description}: ${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(b.amount)}</li>`).join('') : '<p class="text-slate-500 text-sm">Sin bonos.</p>'}</ul></div>
                                    <div><p class="text-sm text-slate-500">Deducciones</p><ul>${deductions.length > 0 ? deductions.map(d => `<li class="text-sm">${d.description}: ${new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(d.amount)}</li>`).join('') : '<p class="text-slate-500 text-sm">Sin deducciones.</p>'}</ul></div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-lg shadow">
                            <h3 class="text-xl font-bold mb-2">Tendencia de Ventas</h3>
                            <canvas id="sales-trend-chart"></canvas>
                        </div>
                    `;

                    if (salesChart) {
                        salesChart.destroy();
                    }
                    const ctx = document.getElementById('sales-trend-chart')?.getContext('2d');
                    if (ctx) {
                        const salesByDate = sellerSales.sort((a, b) => a.timestamp - b.timestamp);
                        salesChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: salesByDate.map(s => new Date(s.timestamp).toLocaleDateString('es-MX')),
                                datasets: [{
                                    label: 'Ventas',
                                    data: salesByDate.map(s => s.total),
                                    borderColor: '#3b82f6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    fill: true,
                                    tension: 0.1
                                }]
                            },
                            options: { responsive: true, scales: { y: { beginAtZero: true } } }
                        });
                    }
                }
                
                document.getElementById('back-to-admin-panel').addEventListener('click', () => showView('perfil-view'));
                document.getElementById('perf-start-date').addEventListener('change', updatePerformanceView);
                document.getElementById('perf-end-date').addEventListener('change', updatePerformanceView);
                updatePerformanceView();
            }

            setupTheme();
        });
    </script>
</body>
</html>
